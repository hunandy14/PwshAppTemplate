PowerShell 高級混合代碼
===

看似PS代碼，但實際上卻可以被命名成cmd或ps1執行

```ps1
@(set 0=^)#)& powershell "iex([io.file]::ReadAllText('%~f0'))"& exit /b
Write-Host "by PSVersion::" $PSVersionTable.PSVersion

```

有以下幾種版本實現
1. 單行版本
2. PS多行註解

<br>

多行註解是巧妙的利用正好 Cmd 對於 PowerShell 註解語法不會跳錯也不會執行的技巧  
  
單行版本也類似技巧，不過應該列入黑魔法範疇了，不是那麼直觀的寫法  

> 總而言之所以能實現的都是正好那些寫法在CMD上不報錯，又正好可以在PS上可忽略實現的  

第三種比較正常一點了，就是合法合規僅僅只是把PS代碼寫在EXIT之下而已
不過這麼做法有個問題是報錯時回報的行數，跟實際行數會不一樣


<br><br>

## 1. 單行版本 的混合代碼
```ps1
@(setlocal enabledelayedexpansion& set "0=%~f0"& set "1=%*"^)#)& powershell "iex('&{'+[io.file]::ReadAllText($env:0)+'}'+$env:1)-ea(1)"& exit /b !errorlevel!
[CmdletBinding()]
param (
    [Parameter(Position=0)]
    [string]$Argument1,
    [string]$Argument2,
    [switch]$ShowInfo
)
Write-Host "Caller   : $env:0 $env:1"
Write-Host "Argument1: $Argument1"
Write-Host "Argument2: $Argument2"
Write-Host "ShowInfo : $ShowInfo"
Exit -1

```

<br>

測試

```ps1
.\test\hiberid.cmd -Argument2 AA -Argument1 "B B" -ShowInfo; Write-Host " LASTEXITCODE = $LASTEXITCODE" -BackgroundColor DarkGreen
```

結果

```ps1
Caller    : C:\Users\hunan\OneDrive\Git Repository\pwshApp\PwshAppTemplate\test\hiberid.cmd -Argument2 AA -Argument1 "B B" -ShowInfo
Argument1 : B B
Argument2 : AA
ShowInfo  : True
LASTEXITCODE = -1
```



<br><br><br>

## 2. PS多行註解 的混合代碼

```ps1
<# ::BatchScript
@echo off & set "0=%~f0" & set "1=%*"
powershell "iex('&{'+[io.file]::ReadAllText($env:0)+'}'+$env:1)-ea(1)"
exit /b %errorlevel%
::PowerShellScript #>
[CmdletBinding()]
param (
    [Parameter(Position=0)]
    [string]$Argument1,
    [string]$Argument2,
    [switch]$ShowInfo
)
Write-Host "Caller   : $env:0 $env:1"
Write-Host "Argument1: $Argument1"
Write-Host "Argument2: $Argument2"
Write-Host "ShowInfo : $ShowInfo"
Exit -1

```

測試

```ps1
.\test\hiberid2-01.bat -Argument2 AA -Argument1 "B B" -ShowInfo; Write-Host " LASTEXITCODE = $LASTEXITCODE" -BackgroundColor DarkGreen
```

結果

```ps1
Caller    : C:\Users\hunan\OneDrive\Git Repository\pwshApp\PwshAppTemplate\test\hiberid.cmd -Argument2 AA -Argument1 "B B" -ShowInfo
Argument1 : B B
Argument2 : AA
ShowInfo  : True
LASTEXITCODE = -1
```
